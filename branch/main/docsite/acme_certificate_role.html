<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>felixfontein.acme.acme_certificate role &mdash; Felixfontein.Acme Collection  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/ansible.css" type="text/css" />
      <link rel="stylesheet" href="../_static/antsibull-minimal.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/rtd-ethical-ads.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/images/Ansible-Mark-RGB_Black.png"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="felixfontein.acme.revoke_old_certificates role" href="revoke_old_certificates_role.html" />
    <link rel="prev" title="felixfontein.acme.account_key_rollover role" href="account_key_rollover_role.html" /><!-- extra head elements for Ansible beyond RTD Sphinx Theme -->




</head>

<body class="wy-body-for-nav"><!-- extra body elements for Ansible beyond RTD Sphinx Theme -->

<div class="DocSite-globalNav ansibleNav">
  <ul>
    <li><a href="https://www.ansible.com/ansiblefest" target="_blank">AnsibleFest</a></li>
    <li><a href="https://www.ansible.com/tower" target="_blank">Products</a></li>
    <li><a href="https://www.ansible.com/community" target="_blank">Community</a></li>
    <li><a href="https://www.ansible.com/webinars-training" target="_blank">Webinars & Training</a></li>
    <li><a href="https://www.ansible.com/blog" target="_blank">Blog</a></li>
  </ul>
</div>

<a class="DocSite-nav" href="https://felixfontein.github.io/ansible-acme/branch/main/" style="padding-bottom: 30px;">

  <img class="DocSiteNav-logo"
    src="../_static/images/Ansible-Mark-RGB_White.png"
    alt="Ansible Logo">
  <div class="DocSiteNav-title">Felixfontein.Acme Collection Docs</div>
</a>
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Felixfontein.Acme Collection
          </a><!--- Based on https://github.com/rtfd/sphinx_rtd_theme/pull/438/files -->

<div class="version">
  
    
  
</div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <label class="sr-only" for="q">Search docs:</label>
    <input type="text" class="st-default-search-input" id="q" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
  
              <ul>
<li class="toctree-l1"><a class="reference internal" href="requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="general_role_parameters.html">General Role Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="acme_account.html">ACME Accounts</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="account_key_rollover_role.html">felixfontein.acme.account_key_rollover role</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">felixfontein.acme.acme_certificate role</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#parameters">Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#selecting-which-root-to-use-with-let-s-encrypt">Selecting which root to use with Let’s Encrypt</a></li>
<li class="toctree-l2"><a class="reference internal" href="#generated-files">Generated files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-playbook">Example playbook</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="revoke_old_certificates_role.html">felixfontein.acme.revoke_old_certificates role</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../_substitute_dns_filter.html">felixfontein.acme._substitute_dns filter – [INTERNAL] Adjust DNS name according to a CNAME substitution map</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../account_key_rollover_role.html">felixfontein.acme.account_key_rollover role – Do account key rollover</a></li>
<li class="toctree-l1"><a class="reference internal" href="../acme_certificate_role.html">felixfontein.acme.acme_certificate role – Issue TLS/SSL certificates from an ACME CA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../revoke_old_certificates_role.html">felixfontein.acme.revoke_old_certificates role – Revoke old certificates</a></li>
</ul>
<!-- extra nav elements for Ansible beyond RTD Sphinx Theme -->

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Felixfontein.Acme Collection</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">felixfontein.acme.acme_certificate role</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">

  
           <div itemprop="articleBody">
             
  <section id="felixfontein-acme-acme-certificate-role">
<span id="ansible-collections-felixfontein-acme-docsite-acme-certificate-role"></span><h1>felixfontein.acme.acme_certificate role<a class="headerlink" href="#felixfontein-acme-acme-certificate-role" title="Permalink to this heading"></a></h1>
<p>This is a role which can use any CA supporting the ACME protocol, such as <a class="reference external" href="https://letsencrypt.org/">Let’s Encrypt</a>, <a class="reference external" href="https://www.buypass.com/ssl/products/acme">Buypass</a> or <a class="reference external" href="https://zerossl.com/features/acme/">ZeroSSL</a>, to issue TLS/SSL certificates for your server.</p>
<p>The main advantage of this approach over others is that <em>almost no code is executed on your webserver</em>: only when you use HTTP challenges, files need to be copied onto your webserver, and afterwards deleted from it. Everything else is executed on your local machine! In particular, the account key is <em>never</em> sent to another machine.</p>
<p>This role does not cover installing the certificates, you have to do that yourself in another role.</p>
<section id="parameters">
<h2>Parameters<a class="headerlink" href="#parameters" title="Permalink to this heading"></a></h2>
<p>See <a class="reference internal" href="general_role_parameters.html#ansible-collections-felixfontein-acme-docsite-general-role-parameters"><span class="std std-ref">General Role Parameters</span></a> for general parameters, and for challenge-specific parameters.</p>
<p>These are the main variables used by this role:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_domains</span></code>: The domain names you want to get a certificate for. Wildcards are only allowed as the first component, i.e. <code class="docutils literal notranslate"><span class="pre">*.example.com</span></code> is ok, while <code class="docutils literal notranslate"><span class="pre">*.*.example.com</span></code> and <code class="docutils literal notranslate"><span class="pre">www.*.example.com</span></code> are not ok. Also, when wildcards are used, not every challenge type is allowed. Let’s Encrypt only allows wildcard domains with the <code class="docutils literal notranslate"><span class="pre">dns-01</span></code> challenge. At least one of <code class="docutils literal notranslate"><span class="pre">acme_certificate_domains</span></code> and <code class="docutils literal notranslate"><span class="pre">acme_certificate_ips</span></code> must be specified.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_ips</span></code>: The IP addresses you want to get a certificate for. Note that this is not supported by every CA! At least one of <code class="docutils literal notranslate"><span class="pre">acme_certificate_domains</span></code> and <code class="docutils literal notranslate"><span class="pre">acme_certificate_ips</span></code> must be specified.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_acme_email</span></code>: Your email address which shall be associated to the ACME account.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_algorithm</span></code>: The algorithm used for creating private keys. The default is <code class="docutils literal notranslate"><span class="pre">&quot;rsa&quot;</span></code>; other choices are <code class="docutils literal notranslate"><span class="pre">&quot;p-256&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;p-384&quot;</span></code> or <code class="docutils literal notranslate"><span class="pre">&quot;p-521&quot;</span></code> for the NIST elliptic curves <code class="docutils literal notranslate"><span class="pre">prime256v1</span></code>, <code class="docutils literal notranslate"><span class="pre">secp384r1</span></code> and <code class="docutils literal notranslate"><span class="pre">secp521r1</span></code>, respectively.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_key_length</span></code>: The bitlength to use for RSA private keys. The default is 4096.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_key_name</span></code>: The basename for storing the keys and certificates. The default is the first domain specified, with <code class="docutils literal notranslate"><span class="pre">*</span></code> replaced by <code class="docutils literal notranslate"><span class="pre">_</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_keys_path</span></code>: Where the keys and certificates are stored. Default value is <code class="docutils literal notranslate"><span class="pre">&quot;keys/&quot;</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_keys_old_path</span></code>: Where old keys and certificates should be copied to; used in case <code class="docutils literal notranslate"><span class="pre">acme_certificate_keys_old_store</span></code> is true. Default value is <code class="docutils literal notranslate"><span class="pre">&quot;keys/old/&quot;</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_keys_old_store</span></code>: If set to <code class="docutils literal notranslate"><span class="pre">true</span></code>, will make copies of old keys and certificates. The copies will be stored in the directory specified by <code class="docutils literal notranslate"><span class="pre">acme_certificate_keys_old_store</span></code>. Default value is <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_keys_old_prepend_timestamp</span></code>: Whether copies of old keys and certificates should be prepended by the current date and time. Default value is <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_regenerate_private_keys</span></code>: Whether to regenerate private keys. Default value is <code class="docutils literal notranslate"><span class="pre">true</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_use_sops_for_key</span></code>: Use <a class="reference external" href="https://github.com/mozilla/sops">Mozilla sops</a> to encrypt private key. Needs <code class="docutils literal notranslate"><span class="pre">.sops.yaml</span></code> file inside the keys directory or somewhere up the directory chain. Default value is <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_ocsp_must_staple</span></code>: Whether a certificate with the OCSP Must Staple extension is requested. Default value is <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_terms_agreed</span></code>: Whether the terms of services are accepted or not. Default value is <code class="docutils literal notranslate"><span class="pre">false</span></code>, usually needs to be set explicitly to <code class="docutils literal notranslate"><span class="pre">true</span></code> to allow creating an ACME account. This is only used for ACME v2.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_challenge</span></code>: The challenge type to use. Should be <code class="docutils literal notranslate"><span class="pre">http-01</span></code> for HTTP challenges (needs access to web server) or <code class="docutils literal notranslate"><span class="pre">dns-01</span></code> for DNS challenges (needs access to DNS provider).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_root_certificate</span></code>: The root certificate for the ACME directory. Default value is <code class="docutils literal notranslate"><span class="pre">https://letsencrypt.org/certs/isrgrootx1.pem</span></code> for the root certificate of Let’s Encrypt.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_root_certificate_for_verification</span></code>: The root certificate to use when <code class="docutils literal notranslate"><span class="pre">acme_certificate_verify_certs=true</span></code> (the default). By default equals <code class="docutils literal notranslate"><span class="pre">acme_certificate_root_certificate</span></code>. It can be useful to set this to <code class="docutils literal notranslate"><span class="pre">https://letsencrypt.org/certs/isrgrootx1.pem</span></code> when <code class="docutils literal notranslate"><span class="pre">acme_certificate_root_certificate</span></code> is set to <code class="docutils literal notranslate"><span class="pre">https://letsencrypt.org/certs/trustid-x3-root.pem.txt</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_deactivate_authzs</span></code>: Whether <code class="docutils literal notranslate"><span class="pre">authz``s</span> <span class="pre">(authorizations)</span> <span class="pre">should</span> <span class="pre">be</span> <span class="pre">deactivated</span> <span class="pre">afterwards.</span> <span class="pre">Default</span> <span class="pre">value</span> <span class="pre">is</span> <span class="pre">``true</span></code>. Set to <code class="docutils literal notranslate"><span class="pre">false</span></code> to be able to re-use <code class="docutils literal notranslate"><span class="pre">authz</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_modify_account</span></code>: Whether the ACME account should be created (if it doesn’t exist) and the contact data (email address) should be updated. Default value is <code class="docutils literal notranslate"><span class="pre">true</span></code>. Set to <code class="docutils literal notranslate"><span class="pre">false</span></code> if you want to use the <a class="reference external" href="https://docs.ansible.com/ansible/devel/collections/community/crypto/acme_account_module.html#ansible-collections-community-crypto-acme-account-module" title="(in Ansible vdevel)"><span class="xref std std-ref">community.crypto.acme_account module</span></a> module to manage your ACME account (not done by this role).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_privatekey_mode</span></code>: Which file mode to use for the private key file. Default value is <code class="docutils literal notranslate"><span class="pre">&quot;0600&quot;</span></code> (octal string), which means read- and writeable by the owner, but not accessible by anyone else (except possibly <code class="docutils literal notranslate"><span class="pre">root</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_select_chain</span></code>: Must be in the format described for the <code class="docutils literal notranslate"><span class="pre">select_chain</span></code> parameter of <a class="reference external" href="https://docs.ansible.com/ansible/devel/collections/community/crypto/acme_certificate_module.html#ansible-collections-community-crypto-acme-certificate-module" title="(in Ansible vdevel)"><span class="xref std std-ref">community.crypto.acme_certificate module</span></a>. Allows to select the certificate chain to be used; <code class="docutils literal notranslate"><span class="pre">acme_certificate_root_certificate</span></code> must be used in conjunction. This can be used for example with <a class="reference external" href="https://community.letsencrypt.org/t/transition-to-isrgs-root-delayed-until-sep-29/125516">Let’s Encrypt</a> to select which root certificate to use. See below for concrete examples how to choose between the Let’s Encrypt roots.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_renewal_on_remaining_days</span></code>: Only renew the certificate if it does not yet exist, or expires in less than the given amount of days.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acme_certificate_verify_auth</span></code>: Only check whether credentials have been provided for DNS provider as role arguments when this is <code class="docutils literal notranslate"><span class="pre">true</span></code> (default).</p></li>
</ul>
</section>
<section id="selecting-which-root-to-use-with-let-s-encrypt">
<h2>Selecting which root to use with Let’s Encrypt<a class="headerlink" href="#selecting-which-root-to-use-with-let-s-encrypt" title="Permalink to this heading"></a></h2>
<p>The following configuration makes sure that the IdenTrust cross-signed intermediate is used, which is more compatible for example for older Android versions than the new IRSG root:</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="nt">acme_certificate_root_certificate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://letsencrypt.org/certs/trustid-x3-root.pem.txt</span>
<span class="nt">acme_certificate_select_chain</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">test_certificates</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">last</span>
<span class="w">    </span><span class="nt">issuer</span><span class="p">:</span>
<span class="w">      </span><span class="nt">CN</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DST Root CA X3</span>
<span class="w">      </span><span class="nt">O</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Digital Signature Trust Co.</span>
<span class="c1"># The following is needed to avoid validation failures now that the TrustID root expired</span>
<span class="nt">acme_certificate_root_certificate_for_verification</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://letsencrypt.org/certs/isrgrootx1.pem</span>
</pre></div>
</div>
<p>The following configuration selects the new IRSG X1 root:</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="nt">acme_certificate_root_certificate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://letsencrypt.org/certs/isrgrootx1.pem</span>
<span class="nt">acme_certificate_select_chain</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">test_certificates</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">last</span>
<span class="w">    </span><span class="nt">issuer</span><span class="p">:</span>
<span class="w">      </span><span class="nt">CN</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ISRG Root X1</span>
<span class="w">      </span><span class="nt">O</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Internet Security Research Group</span>
</pre></div>
</div>
</section>
<section id="generated-files">
<h2>Generated files<a class="headerlink" href="#generated-files" title="Permalink to this heading"></a></h2>
<p>Let’s assume you created TLS keys for <code class="docutils literal notranslate"><span class="pre">www.example.com</span></code>. You have to copy the relevant files to your webserver. The ansible role created the following files:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">keys/www.example.com.key</span></code>: this is the private key for the certificate. Ensure nobody can access it.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">keys/www.example.com.pem</span></code>: this is the certificate itself.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">keys/www.example.com-chain.pem</span></code>: this is the intermediate certificate(s) needed for a trust path.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">keys/www.example.com-fullchain.pem</span></code>: this is the certificate combined with the intermediate certificate(s).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">keys/www.example.com-rootchain.pem</span></code>: this is the intermediate certificate(s) combined with the root certificate. You might need this for OCSP stapling.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">keys/www.example.com-root.pem</span></code>: this is the root certificate of Let’s Encrypt.</p></li>
</ul>
</div></blockquote>
<p>For configuring your webserver, you need the private key (<code class="docutils literal notranslate"><span class="pre">keys/www.example.com.key</span></code>), and either the certificate with intermediate certificate(s) combined in one file (<code class="docutils literal notranslate"><span class="pre">keys/www.example.com-fullchain.pem</span></code>), or the certificate and the intermediate certificate(s) as two separate files (<code class="docutils literal notranslate"><span class="pre">keys/www.example.com.pem</span></code> and <code class="docutils literal notranslate"><span class="pre">keys/www.example.com-chain.pem</span></code>). If you want to use <a class="reference external" href="https://en.wikipedia.org/wiki/OCSP_stapling">OCSP stapling</a>, you might also need <code class="docutils literal notranslate"><span class="pre">keys/www.example.com-rootchain.pem</span></code>.</p>
<p>To get these files onto your web server, you could add tasks as follows:</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">copy private keys</span>
<span class="w">  </span><span class="nt">copy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keys/</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span>
<span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/ssl/private/</span>
<span class="w">    </span><span class="nt">owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">    </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0400&quot;</span>
<span class="w">  </span><span class="nt">with_items</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">www.example.com.key</span>
<span class="w">  </span><span class="nt">notify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reload webserver</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">copy certificates</span>
<span class="w">  </span><span class="nt">copy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keys/</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span>
<span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/ssl/server-certs/</span>
<span class="w">    </span><span class="nt">owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">    </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0444&quot;</span>
<span class="w">  </span><span class="nt">with_items</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">www.example.com-rootchain.pem</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">www.example.com-fullchain.pem</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">www.example.com.pem</span>
<span class="w">  </span><span class="nt">notify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reload webserver</span>
</pre></div>
</div>
<p>The webserver configuration could look as follows (for nginx):</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="n">www.example.com</span><span class="p">:</span><span class="mi">443</span><span class="w"> </span><span class="s">ssl</span><span class="p">;</span><span class="w">  </span><span class="c1"># IPv4: listen to IP www.example.com points to</span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="s">[::]:443</span><span class="w"> </span><span class="s">ssl</span><span class="p">;</span><span class="w">             </span><span class="c1"># IPv6: listen to localhost</span>
<span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.example.com</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Allowing only TLS 1.0 and 1.2, with a very selective amount of ciphers.</span>
<span class="w">    </span><span class="c1"># According to SSL Lab&#39;s SSL server test, this will block:</span>
<span class="w">    </span><span class="c1">#   - Android 2.3.7</span>
<span class="w">    </span><span class="c1">#   - IE 6 and 8 under Windows XP</span>
<span class="w">    </span><span class="c1">#   - Java 6, 7 and 8</span>
<span class="w">    </span><span class="c1"># If that&#39;s not acceptable for you, choose other cipher lists. Look for</span>
<span class="w">    </span><span class="c1"># example at https://wiki.mozilla.org/Security/Server_Side_TLS</span>
<span class="w">    </span><span class="kn">ssl_protocols</span><span class="w"> </span><span class="s">TLSv1.2</span><span class="w"> </span><span class="s">TLSv1</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_prefer_server_ciphers</span><span class="w"> </span><span class="no">on</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_ciphers</span><span class="w"> </span><span class="s">&quot;-ALL</span><span class="w"> </span><span class="s">!ADH</span><span class="w"> </span><span class="s">!aNULL</span><span class="w"> </span><span class="s">!EXP</span><span class="w"> </span><span class="s">!EXPORT40</span><span class="w"> </span><span class="s">!EXPORT56</span><span class="w"> </span><span class="s">!RC4</span><span class="w"> </span><span class="s">!3DES</span><span class="w"> </span><span class="s">!eNULL</span><span class="w"> </span><span class="s">!NULL</span><span class="w"> </span><span class="s">!DES</span><span class="w"> </span><span class="s">!MD5</span><span class="w"> </span><span class="s">!LOW</span><span class="w"> </span><span class="s">ECDHE-ECDSA-AES256-GCM-SHA384</span><span class="w"> </span><span class="s">ECDHE-RSA-AES256-GCM-SHA384</span><span class="w"> </span><span class="s">DHE-RSA-AES256-GCM-SHA384</span><span class="w"> </span><span class="s">ECDHE-ECDSA-AES256-SHA384</span><span class="w"> </span><span class="s">ECDHE-RSA-AES256-SHA384</span><span class="w"> </span><span class="s">DHE-RSA-AES256-SHA256</span><span class="w"> </span><span class="s">ECDHE-ECDSA-AES256-SHA</span><span class="w"> </span><span class="s">ECDHE-RSA-AES256-SHA</span><span class="w"> </span><span class="s">DHE-RSA-AES256-SHA&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># The certificate chain sent to the browser, as well as the private key.</span>
<span class="w">    </span><span class="c1"># Make sure your private key is only accessible by the webserver during</span>
<span class="w">    </span><span class="c1"># configuration loading (which by default is done with user root).</span>
<span class="w">    </span><span class="kn">ssl_certificate</span><span class="w"> </span><span class="s">/etc/ssl/server-certs/www.example.com-fullchain.pem</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_certificate_key</span><span class="w"> </span><span class="s">/etc/ssl/private/www.example.com.key</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># For OCSP stapling, we need a DNS resolver. Here only public Quad9 and</span>
<span class="w">    </span><span class="c1"># Google DNS servers are specified; I would prepent them by your hoster&#39;s</span>
<span class="w">    </span><span class="c1"># DNS servers. You can usually find their IPs in /etc/resolv.conf on your</span>
<span class="w">    </span><span class="c1"># webserver.</span>
<span class="w">    </span><span class="kn">resolver</span><span class="w"> </span><span class="mi">9</span><span class="s">.9.9.9</span><span class="w"> </span><span class="mi">8</span><span class="s">.8.8.8</span><span class="w"> </span><span class="mi">8</span><span class="s">.8.4.4</span><span class="w"> </span><span class="s">valid=300s</span><span class="p">;</span>
<span class="w">    </span><span class="kn">resolver_timeout</span><span class="w"> </span><span class="s">10s</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Enabling OCSP stapling. Nginx will take care of retrieving the OCSP data</span>
<span class="w">    </span><span class="c1"># automatically. See https://wiki.mozilla.org/Security/Server_Side_TLS#OCSP_Stapling</span>
<span class="w">    </span><span class="c1"># for details on OCSP stapling.</span>
<span class="w">    </span><span class="kn">ssl_stapling</span><span class="w"> </span><span class="no">on</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_stapling_verify</span><span class="w"> </span><span class="no">on</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_trusted_certificate</span><span class="w"> </span><span class="s">/etc/ssl/server-certs/www.example.com-rootchain.pem</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Enables a SSL session cache. Adjust the numbers depending on your site&#39;s usage.</span>
<span class="w">    </span><span class="kn">ssl_session_cache</span><span class="w"> </span><span class="s">shared:SSL:50m</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_session_timeout</span><span class="w"> </span><span class="mi">30m</span><span class="p">;</span>
<span class="w">    </span><span class="kn">ssl_session_tickets</span><span class="w"> </span><span class="no">off</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># You should only use HSTS with proper certificates; the ones from Let&#39;s Encrypt</span>
<span class="w">    </span><span class="c1"># are fine for this, self-signed ones are not. See MozillaWiki for more details:</span>
<span class="w">    </span><span class="c1"># https://wiki.mozilla.org/Security/Server_Side_TLS#HSTS:_HTTP_Strict_Transport_Security</span>
<span class="w">    </span><span class="kn">add_header</span><span class="w"> </span><span class="s">Strict-Transport-Security</span><span class="w"> </span><span class="s">&quot;max-age=3155760000</span><span class="p">;</span><span class="kn">&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="kn">charset</span><span class="w"> </span><span class="s">utf-8</span><span class="p">;</span>

<span class="w">    </span><span class="kn">access_log</span><span class="w">  </span><span class="s">/var/log/nginx/www.example.com.log</span><span class="w"> </span><span class="s">combined</span><span class="p">;</span>
<span class="w">    </span><span class="kn">error_log</span><span class="w">  </span><span class="s">/var/log/nginx/www.example.com.log</span><span class="w"> </span><span class="s">error</span><span class="p">;</span>

<span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kn">root</span><span class="w">   </span><span class="s">/var/www/www.example.com</span><span class="p">;</span>
<span class="w">        </span><span class="kn">index</span><span class="w">  </span><span class="s">index.html</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="example-playbook">
<h2>Example playbook<a class="headerlink" href="#example-playbook" title="Permalink to this heading"></a></h2>
<p>This role can be used as follows. Note that it obtains several certificates, and defines variables used for all certificates globally:</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">getting certificates for webserver</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">webserver</span>
<span class="w">  </span><span class="nt">vars</span><span class="p">:</span>
<span class="w">    </span><span class="nt">acme_certificate_acme_account</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;keys/acme-account.key&#39;</span>
<span class="w">    </span><span class="nt">acme_certificate_acme_email</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;mail@example.com&#39;</span>
<span class="w">    </span><span class="c1"># For HTTP challenges:</span>
<span class="w">    </span><span class="nt">acme_certificate_server_location</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;/var/www/challenges/&#39;</span>
<span class="w">    </span><span class="nt">acme_certificate_http_challenge_user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">    </span><span class="nt">acme_certificate_http_challenge_group</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<span class="w">    </span><span class="nt">acme_certificate_http_challenge_folder_mode</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0750&quot;</span>
<span class="w">    </span><span class="nt">acme_certificate_http_challenge_file_mode</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0640&quot;</span>
<span class="w">    </span><span class="c1"># For DNS challenges with route53:</span>
<span class="w">    </span><span class="nt">acme_certificate_dns_provider</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">route53</span>
<span class="w">    </span><span class="nt">acme_certificate_aws_access_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REPLACE_WITH_YOUR_ACCESS_KEY</span>
<span class="w">    </span><span class="nt">acme_certificate_aws_secret_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REPLACE_WITH_YOUR_SECRET_KEY</span>
<span class="w">    </span><span class="c1"># For DNS challenges with ns1:</span>
<span class="w">    </span><span class="c1"># acme_certificate_dns_provider: ns1</span>
<span class="w">    </span><span class="c1"># acme_certificate_ns1_secret_key: REPLACE_WITH_YOUR_SECRET_KEY</span>
<span class="w">    </span><span class="c1"># For DNS challenges with inwx:</span>
<span class="w">    </span><span class="c1"># acme_certificate_dns_provider: inwx</span>
<span class="w">    </span><span class="c1"># acme_certificate_inwx_username: REPLACE_WITH_YOUR_USERNAME</span>
<span class="w">    </span><span class="c1"># acme_certificate_inwx_password: REPLACE_WITH_YOUR_SECRET_PASSWORD</span>

<span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">felixfontein.acme.acme_certificate</span>
<span class="w">      </span><span class="nt">acme_certificate_domains</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;example.com&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;www.example.com&#39;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="c1"># Use DNS challenges:</span>
<span class="w">      </span><span class="nt">acme_certificate_challenge</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dns-01</span>
<span class="w">      </span><span class="c1"># The certificate files will be stored at:</span>
<span class="w">      </span><span class="c1">#    keys/example.com.key  (private key)</span>
<span class="w">      </span><span class="c1">#    keys/example.com.pem  (certificate)</span>
<span class="w">      </span><span class="c1">#    keys/example.com-chain.pem  (intermediate certificate)</span>
<span class="w">      </span><span class="c1">#    keys/example.com-fullchain.pem  (certificate with intermediate certificate)</span>
<span class="w">      </span><span class="c1">#    keys/example.com-root.pem  (root certificate)</span>
<span class="w">      </span><span class="c1">#    keys/example.com-rootchain.pem  (intermediate certificate with root certificate)</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">felixfontein.acme.acme_certificate</span>
<span class="w">      </span><span class="nt">acme_certificate_domains</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;another.example.com&#39;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">acme_certificate_ips</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;1.2.3.4&#39;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">acme_certificate_key_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;another.example.com-rsa&#39;</span>
<span class="w">      </span><span class="nt">acme_certificate_key_length</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4096</span>
<span class="w">      </span><span class="c1"># Use HTTP challenges:</span>
<span class="w">      </span><span class="nt">acme_certificate_challenge</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http-01</span>
<span class="w">      </span><span class="c1"># The certificate files will be stored at:</span>
<span class="w">      </span><span class="c1">#    keys/another.example.com-rsa.key  (private key)</span>
<span class="w">      </span><span class="c1">#    keys/another.example.com-rsa.pem  (certificate)</span>
<span class="w">      </span><span class="c1">#    keys/another.example.com-rsa-chain.pem  (intermediate certificate)</span>
<span class="w">      </span><span class="c1">#    keys/another.example.com-rsa-fullchain.pem  (certificate with intermediate certificate)</span>
<span class="w">      </span><span class="c1">#    keys/another.example.com-rsa-root.pem  (root certificate)</span>
<span class="w">      </span><span class="c1">#    keys/another.example.com-rsa-rootchain.pem  (intermediate certificate with root certificate)</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">felixfontein.acme.acme_certificate</span>
<span class="w">      </span><span class="nt">acme_certificate_domains</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;another.example.com&#39;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">acme_certificate_key_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;another.example.com-ecc&#39;</span>
<span class="w">      </span><span class="nt">acme_certificate_algorithm</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;p-256&#39;</span>
<span class="w">      </span><span class="c1"># Use HTTP challenges (default for challenge is http-01).</span>
<span class="w">      </span><span class="c1"># The certificate files will be stored at:</span>
<span class="w">      </span><span class="c1">#    keys/another.example.com-ecc.key  (private key)</span>
<span class="w">      </span><span class="c1">#    keys/another.example.com-ecc.pem  (certificate)</span>
<span class="w">      </span><span class="c1">#    keys/another.example.com-ecc-chain.pem  (intermediate certificate)</span>
<span class="w">      </span><span class="c1">#    keys/another.example.com-ecc-fullchain.pem  (certificate with intermediate certificate)</span>
<span class="w">      </span><span class="c1">#    keys/another.example.com-ecc-root.pem  (root certificate)</span>
<span class="w">      </span><span class="c1">#    keys/another.example.com-ecc-rootchain.pem  (intermediate certificate with root certificate)</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          

<footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="account_key_rollover_role.html" class="btn btn-neutral float-left" title="felixfontein.acme.account_key_rollover role" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="revoke_old_certificates_role.html" class="btn btn-neutral float-right" title="felixfontein.acme.revoke_old_certificates role" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Felixfontein.Acme Contributors.</p>
  </div>

  
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script><!-- extra footer elements for Ansible beyond RTD Sphinx Theme -->

</body>
</html>