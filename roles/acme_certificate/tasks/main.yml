---
# GNU General Public License v3.0+ (see LICENSES/GPL-3.0-or-later.txt or https://www.gnu.org/licenses/gpl-3.0.txt)
# SPDX-License-Identifier: GPL-3.0-or-later
# SPDX-FileCopyrightText: 2020, Felix Fontein

- name: Sanity checks (1/2)
  ansible.builtin.assert:
    that: "acme_certificate_challenge != 'dns-01' or acme_certificate_dns_provider is not undefined"
    msg: "acme_certificate_dns_provider must be defined for dns-01 DNS challenge"
  run_once: true

- name: Sanity checks (2/2)
  ansible.builtin.assert:
    that: "acme_certificate_domains or acme_certificate_ips"
    msg: "acme_certificate_domains or acme_certificate_ips must be specified"
  run_once: true

# Sanity checks for DNS providers
- include_tasks: dns-{{ acme_certificate_dns_provider }}-sanity.yml
  when: "acme_certificate_challenge == 'dns-01'"

- name: "Test whether old certificate files for {{ ', '.join(acme_certificate_domains + acme_certificate_ips) }} exist"
  ansible.builtin.stat:
    path: "{{ [acme_certificate_keys_path, acme_certificate_key_name] | community.general.path_join }}.pem"
  delegate_to: localhost
  register: acme_certificate_INTERNAL_old_certificate_exists
  when: >-
    acme_certificate_keys_old_store
    or acme_certificate_renewal_on_remaining_days is defined
  run_once: true

- name: Determine expiry of certificate file
  community.crypto.x509_certificate_info:
    path: "{{ [acme_certificate_keys_path, acme_certificate_key_name] | community.general.path_join }}.pem"
    valid_at:
      soon: "+{{ acme_certificate_renewal_on_remaining_days }}d"
  delegate_to: localhost
  register: acme_certificate_INTERNAL_old_certificate_info
  when: >-
    acme_certificate_renewal_on_remaining_days is defined
    and (acme_certificate_INTERNAL_old_certificate_exists.stat.exists | default(true))
  run_once: true

# Only renew certificate when a) it does not yet exist, or b) when acme_certificate_renewal_on_remaining_days has not
# been specified, or c) when the certificate expires in less than acme_certificate_renewal_on_remaining_days days.
- when: >-
    not (acme_certificate_INTERNAL_old_certificate_exists.stat.exists | default(true))
    or acme_certificate_renewal_on_remaining_days is not defined
    or not (acme_certificate_INTERNAL_old_certificate_info.valid_at.soon | default(true))
  block:  # noqa name[missing]
    - include_tasks: obtain-cert.yml
